"""
ì¹´ì¹´ì˜¤í†¡ ì¹œêµ¬ ìë™ ì¶”ê°€ ì›¹ ëŒ€ì‹œë³´ë“œ
ì‘ì„±ì: ì•„ë¦¬ (Claude Code)
ë‚ ì§œ: 2025-12-19

Flask ì›¹ ì•±ìœ¼ë¡œ êµ¬í˜„
"""

from flask import Flask, render_template, request, jsonify, Response
from flask_cors import CORS
import json
import threading
import time
import csv
import pyautogui
import pyperclip
import pygetwindow as gw
import random
import requests
from io import StringIO
import win32gui
import win32con

app = Flask(__name__)
app.config['JSON_AS_ASCII'] = False  # í•œê¸€ ì¸ì½”ë”© ë¬¸ì œ í•´ê²°
CORS(app)

# êµ¬ê¸€ ì‹œíŠ¸ ì„¤ì •
GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/1zDsFPQyrpSGiUvJ3eAqJyR5luwyecVohxKRdetGFGns/export?format=csv&gid=0"

# ì „ì—­ ë³€ìˆ˜
current_task = None
task_status = {
    'running': False,
    'current': 0,
    'total': 0,
    'logs': [],
    'success_count': 0,
    'fail_count': 0,
    'sheet_url': GOOGLE_SHEET_URL
}

def log_message(message):
    """ë¡œê·¸ ì¶”ê°€"""
    task_status['logs'].append({
        'time': time.strftime('%H:%M:%S'),
        'message': message
    })
    # ìµœê·¼ 100ê°œë§Œ ìœ ì§€
    if len(task_status['logs']) > 100:
        task_status['logs'] = task_status['logs'][-100:]

def read_friends_data(sheet_url=None):
    """êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ì¹œêµ¬ ë°ì´í„° ì½ê¸°"""
    if sheet_url is None:
        sheet_url = GOOGLE_SHEET_URL

    friends = []
    try:
        # êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ CSV ë‹¤ìš´ë¡œë“œ
        log_message("ğŸ“¥ êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...")
        response = requests.get(sheet_url, timeout=10)
        response.raise_for_status()

        # UTF-8 ì¸ì½”ë”© ëª…ì‹œ
        response.encoding = 'utf-8'

        # CSV íŒŒì‹±
        csv_data = StringIO(response.text)
        csv_reader = csv.reader(csv_data)

        for row in csv_reader:
            if len(row) >= 2:
                name = row[0].strip()
                phone = row[1].strip()
                message = row[2].strip() if len(row) >= 3 else ""
                friends.append({
                    'name': name,
                    'phone': phone,
                    'message': message
                })

        log_message(f"âœ“ {len(friends)}ëª…ì˜ ë°ì´í„° ë¡œë“œ ì™„ë£Œ")
        return friends

    except requests.exceptions.RequestException as e:
        log_message(f"âœ— êµ¬ê¸€ ì‹œíŠ¸ ì ‘ê·¼ ì‹¤íŒ¨: {e}")
        # ë¡œì»¬ CSV íŒŒì¼ fallback
        try:
            log_message("ğŸ“‚ ë¡œì»¬ CSV íŒŒì¼ ì‹œë„...")
            with open('kakao_friends_full.csv', 'r', encoding='utf-8') as f:
                csv_reader = csv.reader(f)
                for row in csv_reader:
                    if len(row) >= 2:
                        name = row[0].strip()
                        phone = row[1].strip()
                        message = row[2].strip() if len(row) >= 3 else ""
                        friends.append({
                            'name': name,
                            'phone': phone,
                            'message': message
                        })
            log_message(f"âœ“ ë¡œì»¬ íŒŒì¼ì—ì„œ {len(friends)}ëª… ë¡œë“œ")
            return friends
        except FileNotFoundError:
            log_message("âœ— ë¡œì»¬ CSV íŒŒì¼ë„ ì—†ìŒ")
            return None
    except Exception as e:
        log_message(f"âœ— ë°ì´í„° ì½ê¸° ì‹¤íŒ¨: {e}")
        return None

def find_main_kakao_window():
    """ë©”ì¸ ì¹´ì¹´ì˜¤í†¡ ì°½ ì°¾ê¸°"""
    all_windows = gw.getAllWindows()
    kakao_candidates = []

    for window in all_windows:
        title = window.title
        if not title.strip():
            continue

        if 'ì¹´ì¹´ì˜¤í†¡' in title or 'KakaoTalk' in title or 'kakao' in title.lower():
            is_main = (title == "ì¹´ì¹´ì˜¤í†¡" or title == "KakaoTalk" or len(title) < 20)
            kakao_candidates.append({
                'window': window,
                'title': title,
                'is_main': is_main
            })

    if not kakao_candidates:
        return None

    for candidate in kakao_candidates:
        if candidate['is_main']:
            return candidate['window']

    return kakao_candidates[0]['window']

def activate_window(window):
    """ì°½ í™œì„±í™” (ë§ˆìš°ìŠ¤ í´ë¦­ ì‚¬ìš©)"""
    try:
        # ì°½ì´ ìµœì†Œí™”ë˜ì–´ ìˆìœ¼ë©´ ë³µì›
        if window.isMinimized:
            try:
                hwnd = window._hWnd
                win32gui.ShowWindow(hwnd, win32con.SW_RESTORE)
                time.sleep(1.0)
            except:
                pass

        # ì°½ ì¤‘ì•™ ì¢Œí‘œ ê³„ì‚°
        center_x = window.left + window.width // 2
        center_y = window.top + 50  # íƒ€ì´í‹€ë°” ê·¼ì²˜

        # ë§ˆìš°ìŠ¤ë¥¼ ì°½ ìœ„ë¡œ ì´ë™
        pyautogui.moveTo(center_x, center_y, duration=0.3)
        time.sleep(0.3)

        # ì°½ í´ë¦­í•´ì„œ í™œì„±í™”
        pyautogui.click(center_x, center_y)
        time.sleep(1.0)

        # í•œ ë²ˆ ë” í´ë¦­ (í™•ì‹¤í•˜ê²Œ)
        pyautogui.click(center_x, center_y)
        time.sleep(0.5)

        log_message("âœ“ ì°½ í™œì„±í™” ì™„ë£Œ!")
        return True

    except Exception as e:
        log_message(f"âœ— ì°½ í™œì„±í™” ì‹¤íŒ¨: {e}")
        return False

def add_friend_and_send_message(window, friend_data):
    """í•œ ëª…ì˜ ì¹œêµ¬ ì¶”ê°€ ë° ë©”ì‹œì§€ ì „ì†¡"""
    name = friend_data['name']
    phone = friend_data['phone']
    message = friend_data['message']

    try:
        # 1. ì‚¬ëŒ+ ì•„ì´ì½˜ í´ë¦­
        x = window.left + 450
        y = window.top + 66
        pyautogui.click(x, y)
        time.sleep(1.8)

        # 2. ì´ë¦„ ë¶™ì—¬ë„£ê¸°
        pyperclip.copy(name)
        time.sleep(0.3)
        pyautogui.hotkey('ctrl', 'v')
        time.sleep(0.8)

        # 3. Tab 3íšŒ â†’ í°ë²ˆí˜¸ ì…ë ¥ì°½
        for i in range(3):
            pyautogui.press('tab')
            time.sleep(0.3)

        # 4. í°ë²ˆí˜¸ ë¶™ì—¬ë„£ê¸°
        pyperclip.copy(phone)
        time.sleep(0.3)
        pyautogui.hotkey('ctrl', 'v')
        time.sleep(0.8)

        # 5. Tab 1íšŒ + Enter â†’ ì¹œêµ¬ ë“±ë¡
        pyautogui.press('tab')
        time.sleep(0.5)
        pyautogui.press('enter')
        time.sleep(2.0)

        # 6. Enter â†’ ì¼ëŒ€ì¼ì±„íŒ… ì°½ ì—´ê¸°
        pyautogui.press('enter')
        time.sleep(2.5)

        # 7. ë©”ì‹œì§€ ì „ì†¡ (ìˆëŠ” ê²½ìš°ë§Œ)
        try:
            if message:
                pyautogui.hotkey('alt', 'tab')
                time.sleep(0.8)

                pyperclip.copy(message)
                time.sleep(0.3)
                pyautogui.hotkey('ctrl', 'v')
                time.sleep(1.0)

                pyautogui.press('enter')
                time.sleep(1.0)
            else:
                pyautogui.hotkey('alt', 'tab')
                time.sleep(0.5)

            # 8. ì±„íŒ…ì°½ ë‹«ê¸°
            pyautogui.press('esc')
            time.sleep(1.0)

            return True

        except Exception as e:
            # ì¹œêµ¬ ì¶”ê°€ ì‹¤íŒ¨ ì¼€ì´ìŠ¤
            for i in range(3):
                pyautogui.press('esc')
                time.sleep(0.5)
            return False

    except Exception as e:
        log_message(f"âœ— ì—ëŸ¬: {e}")
        return False

def run_task(start, end, delay_min, delay_max):
    """ì‘ì—… ì‹¤í–‰"""
    global task_status

    task_status['running'] = True
    task_status['current'] = 0
    task_status['logs'] = []
    task_status['success_count'] = 0
    task_status['fail_count'] = 0

    log_message("ğŸš€ ì‘ì—… ì‹œì‘!")

    # ì¹œêµ¬ ë°ì´í„° ì½ê¸°
    friends = read_friends_data()
    if not friends:
        log_message("âœ— ì¹œêµ¬ ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        task_status['running'] = False
        return

    friends_to_process = friends[start-1:end]
    task_status['total'] = len(friends_to_process)

    log_message(f"ğŸ“‹ {start}ë²ˆë¶€í„° {end}ë²ˆê¹Œì§€ ì´ {len(friends_to_process)}ëª… ì²˜ë¦¬")

    # ì¹´í†¡ ì°½ ì°¾ê¸°
    main_window = find_main_kakao_window()
    if not main_window:
        log_message("âœ— ì¹´ì¹´ì˜¤í†¡ ì°½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")
        task_status['running'] = False
        return

    log_message(f"âœ“ ì¹´í†¡ ì°½ ë°œê²¬: {main_window.title}")

    # ì°½ í™œì„±í™”
    if not activate_window(main_window):
        log_message("âœ— ì°½ í™œì„±í™” ì‹¤íŒ¨!")
        task_status['running'] = False
        return

    log_message("âœ“ ì°½ í™œì„±í™” ì™„ë£Œ!")

    # 3ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´
    for i in range(3, 0, -1):
        log_message(f"â° {i}ì´ˆ...")
        time.sleep(1)

    # ì¹œêµ¬ ì¶”ê°€ ì‹œì‘
    for i, friend in enumerate(friends_to_process, 1):
        if not task_status['running']:  # ì¤‘ë‹¨ ì²´í¬
            log_message("âš ï¸ ì‘ì—…ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.")
            break

        task_status['current'] = i
        actual_number = start + i - 1

        log_message(f"ğŸ‘¤ [{i}/{len(friends_to_process)}] (ë²ˆí˜¸: {actual_number}) {friend['name']}")

        if add_friend_and_send_message(main_window, friend):
            task_status['success_count'] += 1
            log_message(f"âœ… {friend['name']} ì™„ë£Œ!")
        else:
            task_status['fail_count'] += 1
            log_message(f"âš ï¸ {friend['name']} ì‹¤íŒ¨")

        # ëœë¤ ë”œë ˆì´
        if i < len(friends_to_process):
            if delay_min == delay_max:
                wait_time = delay_min
            else:
                wait_time = random.uniform(delay_min, delay_max)

            log_message(f"â° {wait_time:.1f}ì´ˆ ëŒ€ê¸°...")
            time.sleep(wait_time)

    # ì™„ë£Œ
    log_message("=" * 40)
    log_message("ğŸ“Š ì‘ì—… ì™„ë£Œ!")
    log_message(f"âœ… ì„±ê³µ: {task_status['success_count']}ëª…")
    log_message(f"âŒ ì‹¤íŒ¨: {task_status['fail_count']}ëª…")
    log_message("=" * 40)

    task_status['running'] = False

@app.route('/')
def index():
    """ë©”ì¸ í˜ì´ì§€"""
    return render_template('index.html')

@app.route('/api/friends')
def get_friends():
    """ì¹œêµ¬ ëª©ë¡ ì¡°íšŒ"""
    friends = read_friends_data()
    if friends:
        return jsonify({
            'success': True,
            'friends': friends,
            'total': len(friends),
            'sheet_url': task_status['sheet_url']
        })
    else:
        return jsonify({
            'success': False,
            'message': 'êµ¬ê¸€ ì‹œíŠ¸ ë˜ëŠ” CSV íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
        })

@app.route('/api/sheet-url', methods=['GET', 'POST'])
def sheet_url():
    """êµ¬ê¸€ ì‹œíŠ¸ URL ì¡°íšŒ/ë³€ê²½"""
    global GOOGLE_SHEET_URL

    if request.method == 'POST':
        data = request.json
        new_url = data.get('url', '')

        if not new_url:
            return jsonify({
                'success': False,
                'message': 'URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'
            })

        # URL ìœ íš¨ì„± ê²€ì‚¬
        if 'docs.google.com/spreadsheets' not in new_url:
            return jsonify({
                'success': False,
                'message': 'ì˜¬ë°”ë¥¸ êµ¬ê¸€ ì‹œíŠ¸ URLì´ ì•„ë‹™ë‹ˆë‹¤.'
            })

        # export URLë¡œ ë³€í™˜
        if '/edit' in new_url:
            sheet_id = new_url.split('/d/')[1].split('/')[0]
            new_url = f"https://docs.google.com/spreadsheets/d/{sheet_id}/export?format=csv&gid=0"

        GOOGLE_SHEET_URL = new_url
        task_status['sheet_url'] = new_url

        return jsonify({
            'success': True,
            'message': 'êµ¬ê¸€ ì‹œíŠ¸ URLì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.',
            'url': new_url
        })
    else:
        return jsonify({
            'success': True,
            'url': task_status['sheet_url']
        })

@app.route('/api/start', methods=['POST'])
def start_task():
    """ì‘ì—… ì‹œì‘"""
    global current_task

    if task_status['running']:
        return jsonify({
            'success': False,
            'message': 'ì´ë¯¸ ì‘ì—…ì´ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.'
        })

    data = request.json
    start = int(data.get('start', 1))
    end = int(data.get('end', 1))
    delay_min = float(data.get('delay_min', 1.5))
    delay_max = float(data.get('delay_max', 1.5))

    # ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œë¡œ ì‹¤í–‰
    current_task = threading.Thread(
        target=run_task,
        args=(start, end, delay_min, delay_max)
    )
    current_task.daemon = True
    current_task.start()

    return jsonify({
        'success': True,
        'message': 'ì‘ì—…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.'
    })

@app.route('/api/stop', methods=['POST'])
def stop_task():
    """ì‘ì—… ì¤‘ë‹¨"""
    task_status['running'] = False
    return jsonify({
        'success': True,
        'message': 'ì‘ì—… ì¤‘ë‹¨ ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.'
    })

@app.route('/api/status')
def get_status():
    """ì‘ì—… ìƒíƒœ ì¡°íšŒ"""
    return jsonify(task_status)

@app.route('/api/logs/stream')
def stream_logs():
    """ì‹¤ì‹œê°„ ë¡œê·¸ ìŠ¤íŠ¸ë¦¬ë°"""
    def generate():
        last_log_count = 0
        while True:
            current_log_count = len(task_status['logs'])
            if current_log_count > last_log_count:
                # ìƒˆë¡œìš´ ë¡œê·¸ë§Œ ì „ì†¡
                new_logs = task_status['logs'][last_log_count:]
                for log in new_logs:
                    yield f"data: {json.dumps(log)}\n\n"
                last_log_count = current_log_count
            time.sleep(0.5)

    return Response(generate(), mimetype='text/event-stream')

if __name__ == '__main__':
    import sys
    import io

    # UTF-8 ì¶œë ¥ ì„¤ì • (Windows ì¸ì½”ë”© ë¬¸ì œ í•´ê²°)
    if sys.platform == 'win32':
        sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

    print("="*60)
    print("  ì¹´ì¹´ì˜¤í†¡ ì¹œêµ¬ ìë™ ì¶”ê°€ ì›¹ ëŒ€ì‹œë³´ë“œ")
    print("="*60)
    print("\nğŸŒ ì„œë²„ ì‹œì‘ ì¤‘...")
    print("\nì ‘ì† ì£¼ì†Œ:")
    print("  - ì´ ì»´í“¨í„°: http://localhost:5000")
    print("  - ê°™ì€ ë„¤íŠ¸ì›Œí¬: http://[ë‚´ IP]:5000")
    print("\nâš ï¸  ì„œë²„ë¥¼ ì¤‘ë‹¨í•˜ë ¤ë©´ Ctrl+Cë¥¼ ëˆ„ë¥´ì„¸ìš”.")
    print("="*60)
    print()

    # 0.0.0.0ìœ¼ë¡œ ë°”ì¸ë”©í•˜ë©´ ì™¸ë¶€ì—ì„œë„ ì ‘ì† ê°€ëŠ¥
    app.run(host='0.0.0.0', port=5000, debug=True, threaded=True)
